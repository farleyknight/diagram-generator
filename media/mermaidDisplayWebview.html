<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta http-equiv="Content-Security-Policy" content="default-src 'none'; script-src ${cspSource} 'unsafe-inline' https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js; style-src ${cspSource} 'unsafe-inline'; img-src ${cspSource} data:;">
		<script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
		<style>
			.error-message {
				color: red;
				font-family: monospace;
				white-space: pre-wrap;
				margin: 10px;
				padding: 10px;
				border: 1px solid red;
				display: none;
			}
			.source-code {
				font-family: monospace;
				white-space: pre-wrap;
				margin: 10px;
				padding: 10px;
				border: 1px solid #ccc;
				background-color: #f5f5f5;
			}
			.diagram-container {
				margin: 10px;
				padding: 10px;
				border: 1px solid #ccc;
				position: relative;
				min-height: 200px;
			}
			.loading-spinner {
				display: flex;
				flex-direction: column;
				align-items: center;
				justify-content: center;
				position: absolute;
				top: 0;
				left: 0;
				right: 0;
				bottom: 0;
				background: rgba(255, 255, 255, 0.9);
			}
			.spinner {
				width: 50px;
				height: 50px;
				border: 5px solid #f3f3f3;
				border-top: 5px solid #3498db;
				border-radius: 50%;
				animation: spin 1s linear infinite;
				margin-bottom: 10px;
			}
			.loading-text {
				font-family: system-ui;
				color: #333;
			}
			@keyframes spin {
				0% { transform: rotate(0deg); }
				100% { transform: rotate(360deg); }
				}
			.regenerate-button {
				background-color: #007bff;
				color: white;
				padding: 8px 15px;
				border: none;
				border-radius: 4px;
				cursor: pointer;
				font-family: system-ui;
				margin-top: 10px;
			}
			.regenerate-button:hover {
				background-color: #0056b3;
			}
		</style>
		<script>
			// Define mermaid configuration globally before rendering
			mermaid.initialize({
				startOnLoad: false,
				theme: 'default',
				securityLevel: 'loose'
			});

			const vscode = acquireVsCodeApi();
			
			// Get or initialize state
			const state = vscode.getState() || { rendered: false };

			async function renderMermaid() {
				// Remove any divs that Mermaid might have previously created and left in the body
				document.querySelectorAll('div[id^="dmermaid-svg-"]').forEach(el => el.remove());

				const errorDiv = document.getElementById('error-message');
				const container = document.getElementById('mermaid-container');
				const loadingSpinner = document.getElementById('loading-spinner');

				// Ensure elements exist
				if (!container) {
					console.error("Mermaid container not found!");
					return;
				}
				if (errorDiv) errorDiv.style.display = 'none'; // Hide previous custom errors

				// Clear the main container's content early.
				container.innerHTML = '';

				const preElement = document.querySelector('pre.mermaid');
				console.log("Pre Element:", preElement);
				if (!preElement || !preElement.textContent.trim()) {
					console.log("No diagram code yet, waiting for data...");
					container.innerHTML = '<p style="color:orange;">No diagram syntax found to render.</p>';
					if (!state.rendered) { // Only show spinner if it's an initial load with no data
						loadingSpinner.style.display = 'flex';
					} else {
						loadingSpinner.style.display = 'none';
					}
					return;
				}
				
				// Show spinner before trying to render if we have syntax
				loadingSpinner.style.display = 'flex';

				const rawMermaidSyntaxWithFence = preElement.textContent.trim();
				// Remove potential markdown code fence
				let rawMermaidSyntax = rawMermaidSyntaxWithFence;
				if (rawMermaidSyntax.startsWith('```mermaid')) {
					rawMermaidSyntax = rawMermaidSyntax.substring('```mermaid'.length).trimStart();
				}
				if (rawMermaidSyntax.endsWith('```')) {
					rawMermaidSyntax = rawMermaidSyntax.substring(0, rawMermaidSyntax.length - '```'.length).trimEnd();
				}

				console.log("Cleaned Mermaid Syntax:", rawMermaidSyntax);

				// Define renderId outside the try block so it's accessible in catch
				const renderId = 'mermaid-svg-' + Date.now();

				try {
					if (!rawMermaidSyntax || typeof rawMermaidSyntax !== 'string' || rawMermaidSyntax.trim() === '') {
						console.warn("No valid diagram syntax found to render.");
						container.innerHTML = '<p style="color:orange;">No diagram syntax found to render.</p>';
						loadingSpinner.style.display = 'none';
						// Attempt to remove the (unused) element if mermaid.render was skipped
						document.getElementById(renderId)?.remove();
						return;
					}

					// Use mermaid.render to generate SVG directly
					const result = await mermaid.render(renderId, rawMermaidSyntax);
					console.log('Mermaid.render result:', result);

					// Attempt to remove the element mermaid might have added to the body,
					// regardless of whether the SVG content is valid.
					document.getElementById(renderId)?.remove();

					if (!result || typeof result !== 'object') {
						console.error('Mermaid.render did not return a valid object:', result);
						if (errorDiv) {
							errorDiv.textContent = 'Mermaid rendering failed internally (invalid result object).\n\nSyntax:\n' + rawMermaidSyntax;
							errorDiv.style.display = 'block';
						}
						container.innerHTML = '<p style="color:red;">Failed to render diagram. Internal mermaid error. Check console.</p><button id="regenerate-btn" class="regenerate-button">Try Regenerating Diagram</button>';
						loadingSpinner.style.display = 'none';
						document.getElementById('regenerate-btn')?.addEventListener('click', () => {
							vscode.postMessage({ type: 'regenerateDiagram' });
						});
						return;
					}

					const svg = result?.svg;

					if (typeof svg === 'string' && svg.trim() !== '') {
						console.log('Mermaid rendering successful, inserting SVG.');
						container.innerHTML = svg;
						loadingSpinner.style.display = 'none';
						const bindFunctions = result?.bindFunctions;
						if (bindFunctions) {
							console.log('Applying bindFunctions.');
							bindFunctions(container);
						}
						// Update state to indicate successful render
						state.rendered = true;
						vscode.setState(state);
					} else {
						console.error('Mermaid rendering returned invalid SVG:', svg);
						if (errorDiv) {
							errorDiv.textContent = 'Mermaid rendering failed to produce valid SVG.\n\nSyntax:\n' + rawMermaidSyntax;
							errorDiv.style.display = 'block';
						}
						container.innerHTML = '<p style="color:red;">Failed to render diagram. SVG output was invalid. Check syntax and Developer Tools console.</p><button id="regenerate-btn" class="regenerate-button">Try Regenerating Diagram</button>';
						loadingSpinner.style.display = 'none';
						document.getElementById('regenerate-btn')?.addEventListener('click', () => {
							vscode.postMessage({ type: 'regenerateDiagram' });
						});
					}

				} catch (error) {
					console.error('Mermaid rendering error caught:', error);
					// Attempt to remove the element mermaid might have added, even if an error occurred.
					document.getElementById(renderId)?.remove();
					
					if (errorDiv) {
						errorDiv.textContent = 'Mermaid Syntax Error: ' + (error?.message || String(error)) + '\n\nSyntax:\n' + rawMermaidSyntax;
						errorDiv.style.display = 'block';
					}
					container.innerHTML = '<p style="color:red;">Error rendering diagram. Check syntax and Developer Tools console (Developer: Open Webview Developer Tools).</p><button id="regenerate-btn" class="regenerate-button">Try Regenerating Diagram</button>';
					loadingSpinner.style.display = 'none';
					document.getElementById('regenerate-btn')?.addEventListener('click', () => {
						vscode.postMessage({ type: 'regenerateDiagram' });
					});
				}
			}

			// Listen for messages from the extension
			window.addEventListener('message', event => {
				const message = event.data;
				switch (message.type) {
					case 'updateDiagram':
						// Reset rendered state when new diagram code arrives
						state.rendered = false;
						vscode.setState(state);
						
						// Update the diagram code
						const mermaidPre = document.querySelector('pre.mermaid');
						const diagramSourceDiv = document.querySelector('.source-code#diagram-source');
						if (mermaidPre && diagramSourceDiv) {
							mermaidPre.textContent = message.code;
							diagramSourceDiv.textContent = message.code;
						}
						// Update the prompt text if provided
						if (message.prompt) {
							const promptDiv = document.querySelector('.source-code#diagram-prompt');
							if (promptDiv) {
								promptDiv.textContent = message.prompt;
							}
						}
						// Re-render the diagram
						renderMermaid();
						break;
					case 'updateProgressStatus':
						const loadingTextElement = document.querySelector('#loading-spinner .loading-text');
						if (loadingTextElement) {
							loadingTextElement.textContent = message.text;
						}
						// Ensure spinner is visible when progress updates, unless diagram is already showing
						const loadingSpinner = document.getElementById('loading-spinner');
						const mermaidContainer = document.getElementById('mermaid-container');
						if (loadingSpinner && (!mermaidContainer || !mermaidContainer.querySelector('svg'))) {
							loadingSpinner.style.display = 'flex';
						}
						break;
				}
			});

			 // Initial render logic:
			 // Replace the old conditional initial render logic.
			 // This new logic ensures that renderMermaid() is always called on load,
			 // and the 'rendered' state is correctly initialized for the current session.
			window.addEventListener('load', () => {
				// Reset rendered state for this new webview session.
				// This ensures that if the initial content is empty or fails to render,
				// the state correctly reflects that no diagram is currently successfully rendered.
				state.rendered = false;
				vscode.setState(state); // Persist this reset state.
				
				renderMermaid(); // Attempt to render initial content.
								 // renderMermaid will update and persist state again on success.
			});
		</script>
	</head>
	<body>
		<div id="error-message" class="error-message"></div>
		<div class="diagram-container">
			<div id="mermaid-container">
			</div>
			<div id="loading-spinner" class="loading-spinner">
				<div class="spinner"></div>
				<div class="loading-text">Generating diagram...</div>
			</div>
			<pre class="mermaid" style="display:none">${mermaidCode}</pre>
		</div>
		<details>
			<summary>Show Diagram Source</summary>
			<div class="source-code" id="diagram-source">${mermaidCode}</div>
		</details>
		<details>
			<summary>Show Diagram Prompt</summary>
			<div class="source-code" id="diagram-prompt">${promptText}</div>
		</details>
	</body>
</html>
